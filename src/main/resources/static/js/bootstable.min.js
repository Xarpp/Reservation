"use strict";

function IterarCamposEdit(t, n) {
    function i(t) {
        if (null == colsEdi) return !0;
        for (var n = 0; n < colsEdi.length; n++)
            if (t == colsEdi[n]) return !0;
        return !1
    }
    var o = 0;
    t.each(function() {
        o++, "buttons" != $(this).attr("name") && i(o - 1) && n($(this))
    })
}

function FijModoNormal(t) {
    $(t).parent().find("#bAcep").hide(), $(t).parent().find("#bCanc").hide(), $(t).parent().find("#bEdit").show(), $(t).parent().find("#bElim").show(), $(t).parents("tr").attr("id", "")
}

function FijModoEdit(t) {
    $(t).parent().find("#bAcep").show(), $(t).parent().find("#bCanc").show(), $(t).parent().find("#bEdit").hide(), $(t).parent().find("#bElim").hide(), $(t).parents("tr").attr("id", "editing")
}

function FijModoCreate(t) {
    $(t).parent().find("#bAcep").show(), $(t).parent().find("#bCanc").hide(), $(t).parent().find("#bEdit").hide(), $(t).parent().find("#bElim").show(), $(t).parents("tr").attr("id", "editing")
}


function ModoEdicion(t) {
    return "editing" == t.attr("id")
}

function rowAcep(t) {
    var n = $(t).parents("tr"),
        i = n.find("td");
    ModoEdicion(n) && (IterarCamposEdit(i, function(t) {
        var n = t.find("input").val();
        t.html(n)
    }), FijModoNormal(t), params.onEdit(n))
}

function rowCancel(t) {
    var n = $(t).parents("tr"),
        i = n.find("td");
    ModoEdicion(n) && (IterarCamposEdit(i, function(t) {
        var n = t.find("div").html();
        t.html(n)
    }), FijModoNormal(t))
}

function rowEdit(t, isCreating) {
    var n = $(t).parents("tr"),
        i = n.find("td");
    ModoEdicion(n) || (IterarCamposEdit(i, function(t) {
        var n = t.html(),
            i = '<div style="display: none;">' + n + "</div>",
            o = '<input class="form-control input-sm"  value="' + n + '">';
        t.html(i + o)
    }), isCreating ? FijModoCreate(t) : FijModoEdit(t));
}

function rowElim(t) {
    $(t).parents("tr").remove(), params.onDelete(t);
}

function rowAgreg() {
    var newRow = $("<tr></tr>");
    $tab_en_edic.find("thead tr").find("th").each(function() {
        var cellContent = "buttons" == $(this).attr("name") ? colEdicHtml : "<td></td>";
        newRow.append(cellContent);
    });
    $tab_en_edic.find("tbody").append(newRow);

    // Переводим новую строку в режим редактирования
    rowEdit(newRow.find("td:last-child").find("#bEdit"), true);
}



function TableToCSV(t) {
    var n = "",
        i = "";
    return $tab_en_edic.find("tbody tr").each(function() {
        ModoEdicion($(this)) && $(this).find("#bAcep").click();
        var o = $(this).find("td");
        n = "", o.each(function() {
            "buttons" == $(this).attr("name") || (n = n + $(this).html() + t)
        }), "" != n && (n = n.substr(0, n.length - t.length)), i = i + n + "\n"
    }), i
}

var $delete_icon = '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="transparent" stroke="#d0021b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
var $edit_icon = '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="transparent" stroke="#f5a623" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon></svg>';
var $accept_icon = '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="transparent" stroke="#24a94e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
var $canseled_icon = '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="transparent" stroke="#d0021b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>';

var $tab_en_edic = null,
    params = null,
    colsEdi = null,
    newColHtml = '<div class="btn-group pull-right"><button id="bAcep" type="button" class="btn btn-solid" style="display:none;" onclick="rowAcep(this);">'+ $accept_icon +'</button><button id="bCanc" type="button" class="btn btn-solid" style="display:none;" onclick="rowCancel(this);">'+ $canseled_icon +'</button><button id="bEdit" type="button" class="btn btn-solid" onclick="rowEdit(this, false);">' + $edit_icon + '</button><button id="bElim" type="button" class="btn btn-solid" onclick="rowElim(this);">'+ $delete_icon +'</button></div>',
	colEdicHtml = '<td name="buttons">' + newColHtml + "</td>";

$.fn.SetEditable = function(t) {

    if (!this.data('editable-initialized')) {

    }

    var thButton = '<th name="buttons"></th>';

    if (document.querySelector('th[name="buttons"]')) {
        thButton = "";
    }
    var n = {
        columnsEd: null,
        $addButton: null,
        onEdit: function() {},
        onDelete: function() {},
        onAdd: function() {}
    };
    params = $.extend(n, t), this.find("thead tr").append(thButton), this.find("tbody tr").append(colEdicHtml), $tab_en_edic = this, null != params.$addButton && params.$addButton.off("click").on("click", function() {
        rowAgreg();
    }), null != params.columnsEd && (colsEdi = params.columnsEd.split(","));

    this.data('editable-initialized', true);
};
